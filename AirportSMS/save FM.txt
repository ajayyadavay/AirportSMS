using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Text.Json;
using System.Windows.Forms;
using System.Linq; // Required for string.Join on arrays

public void LoadJsonToGrid(string folderPath, DataGridView dgv)
{
    // 1. Create a DataTable to hold the data
    DataTable dt = new DataTable();

    // 2. Define Columns (Add more if you want to see other specific fields)
    dt.Columns.Add("SPI Name", typeof(string));
    dt.Columns.Add("Objective", typeof(string));
    dt.Columns.Add("Progress %", typeof(string));
    
    // Columns for the Arrays (We use string type to hold the comma-separated values)
    dt.Columns.Add("Prev Year Observed", typeof(string));
    dt.Columns.Add("Curr Year Target %", typeof(string));
    dt.Columns.Add("Curr Year Target Val", typeof(string));
    dt.Columns.Add("Curr Year Observed", typeof(string));

    try
    {
        // 3. Get all JSON files
        string[] files = Directory.GetFiles(folderPath, "*.json");

        // Options to make JSON case-insensitive (safer)
        var options = new JsonSerializerOptions
        {
            PropertyNameCaseInsensitive = true
        };

        foreach (string file in files)
        {
            // 4. Read and Deserialize
            string jsonContent = File.ReadAllText(file);
            SPI spiData = JsonSerializer.Deserialize<SPI>(jsonContent, options);

            if (spiData != null)
            {
                // 5. Create a new row
                DataRow row = dt.NewRow();

                // Map simple fields
                row["SPI Name"] = spiData.SPI_Name;
                row["Objective"] = spiData.SPI_Related_Objective;
                row["Progress %"] = spiData.SPI_Progress_Percentage;

                // 6. FLATTEN ARRAYS: Convert double[] to comma-separated string
                // We use string.Join(", ", array) to combine them
                row["Prev Year Observed"] = spiData.PrevYearObserved != null 
                    ? string.Join(", ", spiData.PrevYearObserved) 
                    : "";

                row["Curr Year Target %"] = spiData.CurrYearTargetPercent != null 
                    ? string.Join(", ", spiData.CurrYearTargetPercent) 
                    : "";

                row["Curr Year Target Val"] = spiData.CurrYearTargetValue != null 
                    ? string.Join(", ", spiData.CurrYearTargetValue) 
                    : "";

                row["Curr Year Observed"] = spiData.CurrYearObserved != null 
                    ? string.Join(", ", spiData.CurrYearObserved) 
                    : "";

                // Add row to table
                dt.Rows.Add(row);
            }
        }

        // 7. Bind to DataGridView
        dgv.DataSource = dt;
        
        // Optional: Auto-resize columns to fit the new data
        dgv.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells);
    }
    catch (Exception ex)
    {
        MessageBox.Show($"Error loading SPIs: {ex.Message}");
    }
}